name: Weekly Summary Report

on:
  schedule:
    # Run every Monday at 9 AM EST
    - cron: '0 14 * * 1'
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  weekly-summary:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install UV
        run: curl -LsSf https://astral.sh/uv/install.sh | sh && export PATH="$HOME/.cargo/bin:$PATH"


      - name: Install dependencies
        run: |
          uv pip install -r requirements.txt || echo "No requirements"

      - name: Generate weekly summary
        run: uv run python scripts/generate_weekly_summary.py

      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: weekly-summary-${{ github.run_id }}
          path: |
            reports/weekly_summary.md
            reports/weekly_summary.json

      - name: Create summary issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            try {
              const summary = fs.readFileSync('reports/weekly_summary.md', 'utf8');

              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸ“… Weekly Summary - ${new Date().toLocaleDateString()}`,
                body: summary,
                labels: ['weekly-summary', 'monitoring', 'automated']
              });
            } catch (e) {
              console.log('Unable to create weekly summary issue:', e);
            }
        continue-on-error: true